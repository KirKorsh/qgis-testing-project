# Руководство по установке и использованию GIS Sync System

## 1. Установка и настройка базы данных PostgreSQL

### Предварительные требования
- Установленный PostgreSQL 12 или выше
- Клиентские утилиты PostgreSQL (`psql`) должны быть доступны в PATH
- Права пользователя на создание баз данных

### Автоматическая установка (рекомендуемый способ)
Запустите установщик, который автоматически создаст базу данных и настроит все компоненты:
```bash
python setup.py
```
Установщик выполнит следующие действия:
- Запросит параметры подключения к PostgreSQL (хост, порт, пользователь, пароль)
- Создаст базу данных с указанным именем (по умолчанию `gis_test`)
- Включит расширение PostGIS в созданной базе данных
- Создаст виртуальное окружение Python и установит все зависимости
- Применит миграции Alembic для создания схемы таблиц

### Ручная установка (если автоматическая не сработала)
Если установщик не смог создать базу данных автоматически, выполните следующие шаги вручную:

#### Через командную строку:
```bash
# Подключитесь к PostgreSQL как пользователь с правами создания БД
psql -U postgres -h localhost

# В интерактивной сессии psql выполните:
CREATE DATABASE gis_test;
\c gis_test
CREATE EXTENSION IF NOT EXISTS postgis;
\q
```

#### Через pgAdmin4:
1. Откройте pgAdmin4
2. Подключитесь к серверу PostgreSQL
3. Щелкните правой кнопкой мыши по "Databases" и выберите "Create" → "Database"
4. Укажите имя базы данных (например, `gis_test`)
5. Нажмите "Save"
6. Откройте созданную базу данных
7. Откройте Query Tool и выполните:
```sql
CREATE EXTENSION IF NOT EXISTS postgis;
```

### Проверка установки базы данных
После создания базы данных проверьте ее доступность:
```bash
psql -U postgres -d gis_test -c "SELECT PostGIS_Version();"
```
Ожидаемый результат: отображение версии установленного PostGIS.

## 2. Установка плагина QGIS

Плагин находится в архиве `qgis-plugin.zip` репозитория.

#### Способ 1: Установка из ZIP-архива (рекомендуется)
1. Откройте QGIS
2. Перейдите в меню: Расширения → Управление расширениями и установкой расширений
3. Нажмите кнопку "Установить из ZIP"
4. Выберите созданный архив `qgis_plugin.zip`
5. Нажмите "Установить плагин"
6. Перезапустите QGIS

#### Способ 2: Ручное копирование
Скопируйте папку `qgis-plugin` из архива в директорию плагинов QGIS:

**Windows:**
```
%APPDATA%\QGIS\QGIS3\profiles\default\python\plugins\
```
Или полный путь:
```
C:\Users\ВАШ_ПОЛЬЗОВАТЕЛЬ\AppData\Roaming\QGIS\QGIS3\profiles\default\python\plugins\
```


После копирования:
1. Перезапустите QGIS
2. Перейдите в Расширения → Управление расширениями
3. Найдите в списке "FastAPI Sync"
4. Установите флажок для активации плагина

### Проверка установки плагина
После перезапуска QGIS:
1. На панели инструментов должна появиться новая кнопка "Синхронизировать"
2. В меню Плагины должен появиться пункт "FastAPI Sync"

## 3. Запуск сервера базы данных

### Проверка состояния PostgreSQL

**Windows:**
```powershell
# Проверка службы PostgreSQL
Get-Service postgresql*

# Запуск службы (если не запущена)
Start-Service postgresql-x64-15  # укажите вашу версию
```

### Настройка подключения к серверу
Если PostgreSQL запущен на другом хосте или порту, отредактируйте файл `.env`:
```bash
# Откройте .env файл в текстовом редакторе
# Измените параметры подключения:
POSTGRES_HOST=ваш_хост
POSTGRES_PORT=ваш_порт
POSTGRES_USER=ваш_пользователь
POSTGRES_PASSWORD=ваш_пароль
POSTGRES_DB=имя_базы_данных
```

### Запуск сервера FastAPI
После настройки базы данных и установки зависимостей запустите сервер:

**Windows:**
```bash
run.bat
```
Или вручную:
```bash
venv\Scripts\activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### Проверка работоспособности сервера
После запуска сервера откройте в браузере:
- http://localhost:8000 - стандартная страница для перехода в административный интерфейс(админку)
- http://localhost:8000/admin - административный интерфейс
- http://localhost:8000/features - список геообъектов (должен вернуть пустой массив или существующие объекты)

## 4. Использование вспомогательных скриптов

### check_db.py
Скрипт для проверки состояния базы данных и создания таблиц при необходимости.

**Основные команды:**
```bash
# Проверить состояние базы данных
python check_db.py

# Проверить состояние с подробным выводом
python check_db.py --check

# Создать таблицы вручную (если миграции не сработали)
python check_db.py --create-tables

# Проверить конкретные аспекты БД
python check_db.py --check-tables
python check_db.py --check-postgis
```

**Результаты выполнения:**
- Проверка подключения к PostgreSQL
- Проверка существования таблицы `features`
- Проверка включения расширения PostGIS
- Проверка таблицы `alembic_version`
- Количество записей в таблице `features`

### debug_connection.py
Скрипт для диагностики проблем с подключением и конфигурацией.

**Использование:**
```bash
python debug_connection.py
```

**Что проверяет скрипт:**
1. Чтение и валидация переменных окружения из `.env`
2. Проверка формата и содержания строки подключения к БД
3. Обнаружение невидимых символов или проблем с кодировкой
4. Формирование полного URL для подключения к БД

**Пример вывода:**
```
=== ПРОВЕРКА ПЕРЕМЕННЫХ ОКРУЖЕНИЯ ===
POSTGRES_HOST: 'localhost'
POSTGRES_PORT: '5432'
POSTGRES_DB: 'gis_test'
POSTGRES_USER: 'postgres'
POSTGRES_PASSWORD: '***'

=== ПРОВЕРКА config.py ===
DATABASE_URL: postgresql+psycopg2://postgres:***@localhost:5432/gis_test
Длина URL: 57
```

### test_alembic_connection.py
Скрипт для тестирования подключения Alembic к базе данных и проверки миграций.

**Использование:**
```bash
python test_alembic_connection.py
```

**Что проверяет скрипт:**
1. Чтение конфигурации из `alembic.ini`
2. Проверка строки подключения в конфигурации Alembic
3. Тестирование подключения к базе данных
4. Проверка существования таблицы `alembic_version`
5. Поиск и отображение доступных файлов миграций

**Типичные проблемы и решения:**

1. **Ошибка: "sqlalchemy.url = driver://user:pass@localhost/dbname"**
   Решение: Обновите `alembic.ini` с правильной строкой подключения

2. **Ошибка: "Таблица alembic_version не существует"**
   Решение: Создайте таблицу вручную или примените миграции

3. **Ошибка подключения к БД**
   Решение: Проверьте параметры в `.env` и доступность PostgreSQL

### Интеграция скриптов в процесс отладки

**Полный процесс отладки при проблемах с подключением:**

1. Сначала проверьте базовое подключение:
   ```bash
   python debug_connection.py
   ```

2. Если переменные окружения в порядке, проверьте Alembic:
   ```bash
   python test_alembic_connection.py
   ```

3. Если Alembic не видит таблиц, создайте их вручную:
   ```bash
   python check_db.py --create-tables
   ```

4. Проверьте общее состояние системы:
   ```bash
   python check_db.py --check
   ```

### Автоматическое восстановление при проблемах

Если система не запускается из-за проблем с БД, выполните полный сброс:

```bash
# 1. Остановите сервер (Ctrl+C)
# 2. Удалите виртуальное окружение и конфигурацию
rm -rf venv .env

# 3. Пересоздайте базу данных
psql -U postgres -c "DROP DATABASE IF EXISTS gis_test;"
psql -U postgres -c "CREATE DATABASE gis_test;"
psql -U postgres -d gis_test -c "CREATE EXTENSION IF NOT EXISTS postgis;"

# 4. Запустите установщик заново
python setup.py

# 5. Запустите сервер
./run.sh
```

### Логирование ошибок

Все вспомогательные скрипты выводят подробные сообщения об ошибках. Для более детального анализа можно включить логирование SQLAlchemy, добавив в `.env`:
```
SQLALCHEMY_ECHO=True
```

Это позволит видеть все SQL-запросы, которые выполняются при подключении к базе данных.

---

**Примечание:** Все скрипты предполагают, что вы находитесь в корневой директории проекта и виртуальное окружение активировано (если требуется). Для автоматической установки скрипты вызываются из `setup.py` и не требуют ручного запуска.
